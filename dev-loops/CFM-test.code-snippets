{
	"Create a project with UI tests": {
		"scope": "powershell",
		"prefix": "CFM01-create-ui-tests",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                          CFM01: Create a project for UI tests                          ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This script creates an application in which you can write tests in the Gherkin language. ",
			"# When creating this application from template, you can automatically initialize user secrets,  ",
			"# connect the FluentAssertions library,   ",
			"# choose a framework to test your application (MStest, NUnit, XUnit )    ",
			"# and generate appsetings.json to configure your tests    ",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#",
			"# Step 1: Create project from template",
			"#",
			"dotnet new pp-test-ui `",
			"--output \"src/Tests.UI\" `",
			"--CreateAppsetingsFile true `",
			"--EnableUserSecrets true `",
			"--TestExecutionFramework \"mstest\" `",
			"--IncludeFluentAssertions true `",
			"--allow-scripts yes",
			"#",
			"# Step 2: Add .feature file to project",
			"mkdir src/Tests.UI/Features",
			"",
			"# Create file for opening warehouse transaction dialog",
			"New-Item -Path \"src/Tests.UI/Features\" -Name \"SubtractStockToAvailableQuantity.feature\" -ItemType \"File\" | Out-Null",
			"",
			"# Create file for saving warehouse transaction data",
			"New-Item -Path \"src/Tests.UI/Features\" -Name \"ErrorNotEnoughStock.feature\" -ItemType \"File\" | Out-Null",
			"",
			"# Add placeholder comments to trigger snippet suggestions",
			"\"// type CFM02 and then press control+space to trigger suggestions of snippets\" | Out-File -FilePath \"src/Tests.UI/Features/SubtractStockToAvailableQuantity.feature\"",
			"\"// type CFM03 and then press control+space to trigger suggestions of snippets\" | Out-File -FilePath \"src/Tests.UI/Features/ErrorNotEnoughStock.feature\"",
			"",
			"# Open files in VS Code for editing",
			"code \"src/Tests.UI/Features/SubtractStockToAvailableQuantity.feature\"",
			"code \"src/Tests.UI/Features/ErrorNotEnoughStock.feature\"",
			"#",
			"dotnet sln add src/Tests.UI"
		]
	},
	"Background: Login to app": {
		"scope": "cucumber",
		"prefix": "CFM02-subtract-stock-to-available-quantity  ",
		"body": [
			"# ╔══════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                      Feature: Subtract Stock from Available Quantity                 ║",
			"# ╚══════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This Gherkin scenario tests subtract item from the Available Quantity of an item after",
			"# creating a Warehouse Transaction.",
			"#",
			"# It verifies that the 'Available Quantity' is recalculated correctly after an",
			"# Outbound transaction is subtracted.",
			"#",
			"# ────────────────────────────────────────────────────────────────────────────────────────",
			"# Background setup: login and item creation",
			"Feature: Subtract Stock",
			"",
			"  Background:",
			"    Given I am logged in to the 'Inventory Management' app as 'a Warehouse Manager'",
			"    And I have created 'a printer warehouse item of quantity 5'",
			"",
			"# ────────────────────────────────────────────────────────────────────────────────────────",
			"# Scenario: Performing the transaction and verifying available quantity",
			"  Scenario: Subtract Stock to Available Quantity",
			"",
			"    When I open the 'Warehouse Transactions' sub area of the 'New Group' group",
			"    And I select the 'Create Warehouse Transaction' command",
			"    And I enter the following into the dialog form",
			"      | Value   | Field    |",
			"      | Outbound | Name     |",
			"      | Printer | Item     |",
			"      | 3       | Quantity |",
			"      | Visa    | Payment Method |",
			"    And I click on 'Save' button in dialog",
			"    And I search for 'Outbound' in the grid",
			"    And I open the record at position '0' in the grid",
			"    And I select a related 'Item' lookup field",
			"    Then I should be able to see a value of '2' in the 'Available Quantity' field"
		],
		"description": "Reusable background for logging into the Warehouse App"
	},
	"Scenario: Not Enough Product In Stock": {
		"scope": "cucumber",
		"prefix": "CFM03-error-not-enough-stock",
		"body": [
			"# ╔══════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                  Feature: Error Handling for Warehouse Transactions                  ║",
			"# ╚══════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This Gherkin scenario tests error handling when attempting to create a Warehouse",
			"# Transaction with a requested quantity that exceeds available stock.",
			"#",
			"# It verifies that a proper error message is shown to the user.",
			"#",
			"# ────────────────────────────────────────────────────────────────────────────────────────",
			"# Scenario: Creating a transaction with quantity greater than stock",
			"Feature: Error Validation - Not Enough Stock",
			"",
			"  Background:",
			"    Given I am logged in to the 'Inventory Management' app as 'a Warehouse Manager'",
			"    And I have created 'a pen warehouse item of quantity 5'",
			"",
			"  Scenario: Error Message for Insufficient Stock",
			"",
			"    When I open the 'Warehouse Transactions' sub area of the 'New Group' group",
			"    And I select the 'Create Warehouse Transaction' command",
			"    And I enter the following into the dialog form",
			"      | Value             | Field   |",
			"      | Test Transaction | Name     |",
			"      | 10               | Quantity |",
			"      | Pen              | Item     |",
			"      | Cash             | Payment Method |",
			"    And I click on 'Save' button in dialog",
			"    Then an error dialog should be displayed with the text 'Not enough product in stock. Available: 5, requested: 10.'"
		],
		"description": "Scenario for testing stock validation and error messages"
	},
	"Setup ui test": {
		"scope": "powershell",
		"prefix": "CFM04-Setup-UI-tests",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                                   CFM03: Setup UI Test                                   ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# Once we have uploaded the solution and published our application, we are ready to run tests.",
			"# This script guides you through the process of configuring and running UI tests for a .NET application.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Step 1: Set application URL to appsettings.json",
			"$$appSettingsFilePath = Join-Path $$PSScriptRoot \"src/Tests.UI/appsettings.json\"",
			"$$json = Get-Content -Path $$appSettingsFilePath -Raw | ConvertFrom-Json -AsHashtable -ErrorAction Stop",
			"$$json['url'] = $$devEnvUrl",
			"$$json | ConvertTo-Json -Depth 10 | Set-Content -Path $$appSettingsFilePath -Encoding UTF8",
			"",
			"# Step 2: Add testing user data to NuGet User Secrets",
			"# Purpose: Store sensitive test user credentials and persona information securely, outside of source code.",
			"# Instructions:",
			"#   a) Open a terminal in your test project folder.",
			"      cd .\\src\\Tests.UI",
			"",
			"#   b) Add test user data using the following commands:",
			"#",
			"      dotnet user-secrets set \"Users:0:Username\" \"int0022-testing@demo.talxis.com\"",
			"      dotnet user-secrets set \"Users:0:Password\" \"$$TestUserPassword\"",
			"#",
			"      dotnet user-secrets set \"Personas:0:Alias\" \"a Warehouse Manager\"",
			"      dotnet user-secrets set \"Personas:0:Username\" \"int0022-testing@demo.talxis.com\"",
			"      dotnet user-secrets set \"Personas:0:SecurityRoles:0\" \"979144c2-989b-41a5-a146-6b3ea4130e8c\"",
			"      dotnet user-secrets set \"Personas:0:SecurityRoles:1\" \"$$WarehouseManagerGuidId\"",
			"#",
			"      dotnet user-secrets set \"Personas:1:Alias\" \"a Warehouse Worker\"",
			"      dotnet user-secrets set \"Personas:1:Username\" \"int0022-testing@demo.talxis.com\"",
			"      dotnet user-secrets set \"Personas:1:SecurityRoles:0\" \"979144c2-989b-41a5-a146-6b3ea4130e8c\"",
			"      dotnet user-secrets set \"Personas:1:SecurityRoles:1\" \"$$WarehouseWorkerId\"",
			"#",
			"      dotnet user-secrets set \"applicationUser:TenantId\" $$testServicePrincipal.tenant",
			"      dotnet user-secrets set \"applicationUser:ClientId\" $$testServicePrincipal.appId",
			"      dotnet user-secrets set \"applicationUser:ClientSecret\" $$testServicePrincipal.password",
			"#",
			"#   c) Ensure these users and settings exist in the system under test and are configured properly.",
			"      cd .\\..\\..",
			"",
		]
	},
	"CreateWarehouseItemData": {
		"scope": "powershell",
		"prefix": "CFM05-create-warehouseitem-json",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                CFM10: Create sample warehouse item JSON file for testing               ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This script generates a sample JSON file that represents a warehouse item record in",
			"# Dataverse-style structure. Useful for test data or prototyping import logic.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"$$relativePath = \"src/Tests.UI/Data\"",
			"mkdir $$relativePath",
			"$$filename = \"a printer warehouse item of quantity 5.json\"",
			"$$path = Join-Path -Path (Resolve-Path -Relative $$relativePath) -ChildPath $$filename",
			"",
			"$$jsonObject = @{",
			"    \"@logicalName\" = \"${${publisherPrefix}}_warehouseitem\"",
			"    \"@alias\"       = \"the printer warehouse item of quantity 5\"",
			"    \"${${publisherPrefix}}_name\"     = \"Printer\"",
			"    \"${${publisherPrefix}}_availablequantity\" = 5",
			"}",
			"",
			"$$jsonContent = $$jsonObject | ConvertTo-Json -Depth 3",
			"Set-Content -Path $$path -Value $$jsonContent -Encoding UTF8",
			"",
			"$$filename = \"a pen warehouse item of quantity 5.json\"",
			"$$path = Join-Path -Path (Resolve-Path -Relative $$relativePath) -ChildPath $$filename",
			"",
			"$$jsonObject = @{",
			"    \"@logicalName\" = \"${${publisherPrefix}}_warehouseitem\"",
			"    \"@alias\"       = \"the pen warehouse item of quantity 5\"",
			"    \"${${publisherPrefix}}_name\"     = \"Pen\"",
			"    \"${${publisherPrefix}}_availablequantity\" = 5",
			"}",
			"",
			"$$jsonContent = $$jsonObject | ConvertTo-Json -Depth 3",
			"Set-Content -Path $$path -Value $$jsonContent -Encoding UTF8",
		]
	},
	"Run dotnet test": {
		"scope": "powershell",
		"prefix": "CFM06-run-dotnet-test",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                                CFM04: Run dotnet test                                  ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This command runs automated UI or integration tests in your .NET test project.",
			"# Make sure all dependencies are configured, including appsettings and user secrets.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Step 1: Run the tests with dotnet test",
			"dotnet test `",
		]
	},
	"Create a project with Script tests": {
		"scope": "powershell",
		"prefix": "CFM07-create-script-tests",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                         CFM09: Create a project for Script tests                        ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This command scaffolds a test project for JavaScript/TypeScript web resources.",
			"# It links to an existing built script to enable isolated unit tests.",
			"#",
			"dotnet new pp-script-test`",
			"--output \"src/Scripts.Tests\" `",
			"--ScriptLibraryPath \"..\\Solutions.UI\\TS\\build\\udpp_main.js\" `",
			"--ScriptTestProjectName \"Scripts.Tests\"",
			"",
			"# Open files in VS Code for editing",
			"code \"src/Scripts.Tests/tests/actions.test.js\"",
			"code \"src/Scripts.Tests/tests/actions.test.js\"",
			"#",
			"dotnet sln add src/Scripts.Tests"
		]
	},
	"Open dialog and refresh control": {
		"scope": "javascript",
		"prefix": "CFM08-jest-open-dialog",
		"body": [
			"const core = require(process.env.JETS_CORE);",
			"",
			"const { loadWebResource } = require('./utils/loadWebRes');",
			"",
			"beforeAll(() => core.setupXrm());",
			"",
			"beforeEach(() => {",
			"  core.resetXrmMocks();",
			"  Xrm.Navigation.openDialog = jest.fn();",
			"});",
			"",
			"test('opens dialog and refreshes control', async () => {",
			"  const sandbox = loadWebResource(process.env.WEBRES_PATH);",
			"  const { MyRibbon } = sandbox;",
			"  const ctrl = { refresh: jest.fn() };",
			"  await MyRibbon.Dialogs.OpenDialog('udpp_WarehouseTransactionDialog', ctrl);",
			"  expect(Xrm.Navigation.openDialog).toHaveBeenCalledWith(",
			"    'udpp_WarehouseTransactionDialog',",
			"    expect.objectContaining({ position: 1, height: 900, width: 900 }),",
			"    null",
			"  );",
			"  expect(ctrl.refresh).toHaveBeenCalledTimes(1);",
			"});"
		]
	},
	"Jest: createRecord success and close window": {
		"scope": "javascript",
		"prefix": "CFM09-jest-create-record-close",
		"body": [
			"const core = require(process.env.JETS_CORE);",
			"",
			"const { makeAttr, makeLookup, makeForm, makeExecutionContext } = core;",
			"const { loadWebResource } = require('./utils/loadWebRes');",
			"",
			"beforeAll(() => core.setupXrm());",
			"",
			"beforeEach(() => {",
			"  core.resetXrmMocks();",
			"  Xrm.Utility.getEntityMetadata = jest.fn();",
			"  Xrm.WebApi.createRecord = jest.fn();",
			"  Xrm.Navigation.openErrorDialog = jest.fn();",
			"  if (!window.close) window.close = () => {};",
			"});",
			"",
			"test('createRecord and close window', async () => {",
			"  const sandbox = loadWebResource(process.env.WEBRES_PATH);",
			"  const { UdppDialog } = sandbox;",
			"  const form = makeForm({",
			"    'udpp_name': makeAttr('TRX-001'),",
			"    'udpp_quantity': makeAttr(5),",
			"    'udpp_paymentmethod': makeAttr(2),",
			"    'udpp_itemid': makeLookup({",
			"      id: '{e3588fd9-c98c-4c13-9b75-5ff09688b468}',",
			"      entityType: 'udpp_warehouseitem',",
			"      name: 'Item A'",
			"    })",
			"  });",
			"  Xrm.Utility.getEntityMetadata.mockResolvedValue({ EntitySetName: 'udpp_warehouseitems' });",
			"  Xrm.WebApi.createRecord.mockResolvedValue({ id: '00c0cd68-cb61-4251-bf1e-8e654de2f989' });",
			"  await UdppDialog.Actions.saveAndClose(makeExecutionContext(form));",
			"  const [entity, payload] = Xrm.WebApi.createRecord.mock.calls[0];",
			"  expect(entity).toBe('udpp_warehousetransaction');",
			"  expect(payload).toMatchObject({",
			"    udpp_name: 'TRX-001',",
			"    udpp_quantity: 5,",
			"    udpp_paymentmethod: 2",
			"  });",
			"  expect(payload['udpp_itemid@odata.bind'])",
			"    .toBe('/udpp_warehouseitems(e3588fd9-c98c-4c13-9b75-5ff09688b468)');",
			"  expect(form.ui.close).toHaveBeenCalledTimes(1);",
			"});"
		]
	},
	
}