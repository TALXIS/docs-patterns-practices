{
	"Create a new Power Platform developer environment": {
		"scope": "powershell",
		"prefix": "CFD01-create-dev-env",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║               CFD01: Create a new Power Platform developer environment                 ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# Creating a Power Platform developer environment is significantly easier than traditional",
			"# PaaS/IaaS setups. With a single command, all the required infrastructure (backend, frontend,",
			"# database, networking, APIs and security) is ready in few moments.",
			"#",
			"# Any user can create up to 3 developer environments for free by assigning themselves the",
			"# Power Apps Developer Plan (https://aka.ms/PowerApps/DeveloperPlan).",
			"#",
			"# In larger projects, you may set up automation to deploy daily CI builds into a queue",
			"# of environments that developers can claim and use for their feature implementation.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Create a new developer environment (this may take some time).",
			"$$devEnvHostname = \"${5:inventorymgmtdev01}\"",
			"",
			"pac admin create `",
			"--name \"${1:Inventory Management Demo DEV}\" `",
			"--currency ${2:EUR} `",
			"--region ${3:europe} `",
			"--type ${4:Developer} `",
			"--domain $$devEnvHostname `",
			"",
			"$$devEnvUrl = \"https://$$devEnvHostname.crm4.dynamics.com/\"",
		]
	},
	"Authenticate and connect to the development environment": {
		"scope": "powershell",
		"prefix": "CFD02-auth-connect-dev-env",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║              CFD02: Authenticate and connect to the development environment            ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# Before working with the development environment using the CLI, it's a good practice to",
			"# clear any existing authentication profiles. This helps prevent accidental communication",
			"# with the wrong environment and ensures that all subsequent commands are executed in the",
			"# correct context.The following command clears the current authentication profile and ",
			"# establishes a new connection to the environment we created earlier.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Step 1: Clear any existing authentication profiles.",
			"pac auth clear",
			"",
			"# Step 2: Authenticate and connect to the development environment",
			"pac auth create --environment \"$$devEnvUrl\""
		]
	},
	"Import the package to your Dataverse environment": {
		"scope": "powershell",
		"prefix": "CFD03-import-package-to-dev-env",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                 CFD03: Import the package to your Dataverse environment                ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# We are now ready to deploy the solutions to the Dataverse environment we created earlier.",
			"# On Windows, you can use the package deployer to deploy solutions as a package.",
			"# However, on macOS, the package deployer is not supported yet, so we need to manually import",
			"# the solutions one by one.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Step 1: Build the whole repository (as unmanaged solutions).",
			"dotnet publish",
			"",
			"# Step 2: Import the locally built solutions into Dataverse for modification in Power Apps Maker.",
			"pac package deploy --package \"./src/Packages.Main/bin/Debug/Packages.Main.1.0.0.pdpkg.zip\"",
			"",
			"# Step 3: Open the Power Apps Maker in the web browser.",
			"pac tool maker"
		]
	},
	"Create a test environment": {
		"scope": "powershell",
		"prefix": "CFD04-create-test-environment",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                         CFD04: Create a test environment                               ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# A test environment (UAT) is used for testing your solutions before they are deployed ",
			"# to production.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Step 1: Create a new test environment.",
			"pac admin create `",
			"--name \"${1:Inventory Management Demo UAT}\" `",
			"--currency ${2:EUR} `",
			"--region ${3:europe} `",
			"--type ${4:Sandbox} `",
			"--domain ${5:inventorymgmtuat}"
		]
	},
	"Add a test user to the test environment": {
		"scope": "powershell",
		"prefix": "CFD05-add-test-user",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                        CFD05: Add a test user to environments                          ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# ",
			"# ",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Step 1: You can add other users to your environment (sharing dev envs is not a good practice!)",
			"# In this case we will add user wich will be used for running automated UI tests",
			"# Note that the value for the user parameter should be username, not email",
			"pac admin assign-user `",
			"--user \"${1:int0022-testing_demo.talxis.com#EXT#@thenetworg.onmicrosoft.com}\" `",
			"--role \"${2:System Administrator}\""
		]
	},
	"Create a Service Principal (no Azure roles)": {
		"scope": "powershell",
		"prefix": "CFD06-create-spn",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                          CFD06: Create a Service Principal                             ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This command creates an Entra ID (AAD) Service Principal without assigning any Azure roles.",
			"# The resulting appId, secret, and tenant will be used in later steps.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                      Command",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"$$testUserServicePrincipal = az ad sp create-for-rbac `",
			"  --name \"Power Apps Test Automation\" `",
			"  --skip-assignment `",
			"  | ConvertFrom-Json"
		]
	},
	"Create a Dataverse App User from the service prondipal and assign a security role": {
		"scope": "powershell",
		"prefix": "CFD07-add-spn-user",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║               CFD07: Create a Dataverse App User for the service principal             ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This script creates a Dataverse user for a Service Principal (SPN). It dynamically detects",
			"# the Business Unit and System Administrator role by querying the current user context, making",
			"# the process more automated and robust for CI/CD environments.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                     Parameters",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"$$testClientId = $$testUserServicePrincipal.appId  # Entra ID Application (client) ID",
			"",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                          Step 1: Get Auth Token + WhoAmI Info",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"$$devEnvAccessToken = (Get-AzAccessToken -ResourceUrl $$devEnvUrl).Token",
			"",
			"$$whoAmIUrl = \"$$devEnvUrl/api/data/v9.2/WhoAmI\"",
			"$$whoAmIResponse = Invoke-RestMethod -Uri $$whoAmIUrl -Method Get -Headers @{",
			"    \"Authorization\"     = \"Bearer $$devEnvAccessToken\"",
			"}",
			"",
			"$$businessUnitId = $$whoAmIResponse.BusinessUnitId",
			"$$userId = $$whoAmIResponse.UserId",
			"",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                  Step 2: Resolve 'System Administrator' Role ID",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"$$userUrl = \"$$devEnvUrl/api/data/v9.2/systemusers($$userId)?`$$expand=systemuserroles_association(`$$select=name,roleid)\"",
			"$$userResponse = Invoke-RestMethod -Uri $$userUrl -Method Get -Headers @{",
			"    \"Authorization\"     = \"Bearer $$devEnvAccessToken\"",
			"}",
			"",
			"$$systemAdminRole = $$userResponse.systemuserroles_association | Where-Object { $$_.name -ieq \"System Administrator\" }",
			"$$roleId = $$systemAdminRole.roleid",
			"",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#               Step 3: Create New SPN-Linked SystemUser in Dataverse",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"$$headers = @{",
			"    Authorization       = \"Bearer $$devEnvAccessToken\"",
			"    \"Content-Type\"     = \"application/json\"",
			"    \"Prefer\"           = \"return=representation\"",
			"}",
			"",
			"$$createBody = @{",
			"    applicationid = $$testClientId",
			"    isdisabled = $$false",
			"    accessmode = 4",
			"    \"businessunitid@odata.bind\" = \"/businessunits($$businessUnitId)\"",
			"} | ConvertTo-Json -Depth 3",
			"",
			"$$createUserResponse = Invoke-RestMethod -Uri \"$$devEnvUrl/api/data/v9.0/systemusers\" -Method Post -Headers $$headers -Body $$createBody",
			"$$userId = $$createUserResponse.systemuserid",
			"",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                          Step 4: Assign Security Role to User",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"$$associationUri = \"$$devEnvUrl/api/data/v9.0/systemusers($$userId)/systemuserroles_association/`$$ref\"",
			"$$body = @{",
			"    \"@odata.id\" = \"$$devEnvUrl/api/data/v9.0/roles($$roleId)\"",
			"} | ConvertTo-Json -Compress",
			"",
			"$$associationResponse = Invoke-RestMethod -Method Post -Uri $$associationUri -Headers $$headers -Body $$body"
		]
	},
}
