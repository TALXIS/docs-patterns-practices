{
    "Create a Dataverse solution project for business logic": {
		"scope": "powershell",
		"prefix": "CFB10-create-logic-solution",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║               CFB10: Create a Dataverse solution project for business logic            ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This solution will contain all custom business logic for the Dataverse environment.",
			"# It is intended for managing plugins — such as event handlers, validations, and automation",
			"# that are triggered by changes in the Dataverse data.",
			"#",
			"# Templates automatically add new projects to the .sln file.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"# Step 1: Create a solution project for business logic using the installed template.",
			"dotnet new pp-solution `",
			"--output \"src/Solutions.Logic\" `",
			"--PublisherName \"tomas\" `",
			"--PublisherPrefix \"tom\" `",
			"--allow-scripts yes",
			"",
			"# Step 2: Add the solution project to the Package Deployer project as a .NET ProjectReference item.",
			"pac package add-reference --path ../Solutions.Logic/",
		]
	},
	"Initialize Plugins.Warehouse plugin project with two handlers": {
		"scope": "powershell",
		"prefix": "CFC01-init-plugins-warehouse",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║       CFC01: Initialize Plugins.Warehouse plugin project with signing and handlers      ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This script automates the setup of a new Dataverse plugin project for handling",
			"# warehouse-related operations. It performs the following:",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Script",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"mkdir src/Plugins.Warehouse",
			"",
			"cd src/Plugins.Warehouse",
			"",
			"# Step 1: Locate sn.exe to generate signing key",
			"$$possiblePaths = @(",
			"    \"${${env:env:ProgramFiles(x86)}}\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.8 Tools\\sn.exe\",",
			"    \"${${env:env:ProgramFiles(x86)}}\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.7.2 Tools\\sn.exe\",",
			"    \"${${env:env:ProgramFiles(x86)}}\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.7.1 Tools\\sn.exe\",",
			"    \"${${env:env:ProgramFiles(x86)}}\\Microsoft SDKs\\Windows\\v10.0A\\bin\\NETFX 4.7 Tools\\sn.exe\"",
			")",
			"$$snPath = $$possiblePaths | Where-Object { Test-Path $$_ } | Select-Object -First 1",
			"",
			"",
			"# Step 2: Generate key file",
			"$$keyFile = \"PluginKey.snk\"",
			"& $$snPath -k $$keyFile",
			"",
			"cd ../../",
			"",
			"# Step 3: Initialize plugin project",
			"dotnet new pp-plugin `",
			"--output \"src/Plugins.Warehouse\" `",
			"--PublisherName \"tomas\" `",
			"--SigningKeyFilePath \"PluginKey.snk\" `",
			"--Company \"NETWORG\" `",
			"--allow-scripts yes",
			"",
			"# Step 4: Add custom plugin class files",
			"cd src/Plugins.Warehouse",
			"",
			"New-Item -Path . -Name \"ValidateWarehouseTransactionPlugin.cs\" -ItemType \"File\" | Out-Null",
			"New-Item -Path . -Name \"SubtractQuantityPlugin.cs\" -ItemType \"File\" | Out-Null",
			"",
			"\"// type CFC02 and then press control+space to trigger suggestions of snippets\" | Out-File -FilePath \"ValidateWarehouseTransactionPlugin.cs\"",
			"\"// type CFC03 and then press control+space to trigger suggestions of snippets\" | Out-File -FilePath \"SubtractQuantityPlugin.cs\"",
			"",
			"code \"ValidateWarehouseTransactionPlugin.cs\"",
			"code \"SubtractQuantityPlugin.cs\"",
			"cd ../../",
			""
		]
	},
	"Validate Warehouse Transaction Plugin": {
		"scope": "csharp",
		"prefix": "CFC02-validate-warehouse-plugin",
		"body": [
			"// ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"// ║            CFC02: Plugin - Validate Warehouse Transaction Quantity (PreValidation)     ║",
			"// ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"//",
			"// This plugin checks if the requested quantity exceeds available quantity",
			"// for a Warehouse Item and throws an exception if validation fails.",
			"//",
			"// Triggered on: Create → tom_warehousetransaction",
			"// Stage: PreValidation",
			"using Microsoft.Xrm.Sdk;",
			"using Microsoft.Xrm.Sdk.Query;",
			"using System;",
			"",
			"namespace Plugins.Warehouse",
			"{",
			"    public class ValidateWarehouseTransactionPlugin : PluginBase",
			"    {",
			"        public ValidateWarehouseTransactionPlugin(string unsecureConfiguration, string secureConfiguration)",
			"            : base(typeof(ValidateWarehouseTransactionPlugin))",
			"        {",
			"        }",
			"",
			"        protected override void ExecuteDataversePlugin(ILocalPluginContext localPluginContext)",
			"        {",
			"            if (localPluginContext == null)",
			"            {",
			"                throw new ArgumentNullException(nameof(localPluginContext));",
			"            }",
			"",
			"            var context = localPluginContext.PluginExecutionContext;",
			"            var serviceFactory = localPluginContext.OrgSvcFactory;",
			"            var service = serviceFactory.CreateOrganizationService(context.UserId);",
			"            var tracingService = localPluginContext.TracingService;",
			"",
			"            if (!(context.InputParameters.Contains(\"Target\") && context.InputParameters[\"Target\"] is Entity target) || target.LogicalName != \"tom_warehousetransaction\")",
			"                return;",
			"",
			"            if (!target.Contains(\"tom_quantity\") || !target.Contains(\"tom_itemid\"))",
			"                return;",
			"",
			"            try",
			"            {",
			"                var quantity = (int)target[\"tom_quantity\"];",
			"                var itemRef = (EntityReference)target[\"tom_itemid\"];",
			"",
			"                var item = service.Retrieve(\"tom_warehouseitem\", itemRef.Id, new ColumnSet(\"tom_availablequantity\"));",
			"                var available = (int)item[\"tom_availablequantity\"];",
			"",
			"                if (quantity > available)",
			"                {",
			"                    throw new InvalidPluginExecutionException($\"Not enough product in stock. Available: {available}, requested: {quantity}.\");",
			"                }",
			"            }",
			"            catch (Exception ex)",
			"            {",
			"                tracingService.Trace(\"Plugin1 Exception: {0}\", ex.ToString());",
			"                throw;",
			"            }",
			"        }",
			"    }",
			"}"
		]
	},
	"Subtract Quantity Plugin": {
		"scope": "csharp",
		"prefix": "CFC03-subtract-quantity-plugin",
		"body": [
			"// ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"// ║         CFC03: Plugin - Subtract Quantity From Available (PostOperation)               ║",
			"// ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"//",
			"// This plugin subtracts the requested quantity from the available quantity of",
			"// a Warehouse Item after a transaction is created.",
			"//",
			"// Triggered on: Create → tom_warehousetransaction",
			"// Stage: PostOperation",
			"using Microsoft.Xrm.Sdk;",
			"using Microsoft.Xrm.Sdk.Query;",
			"using System;",
			"",
			"namespace Plugins.Warehouse",
			"{",
			"    public class SubtractQuantityPlugin : PluginBase",
			"    {",
			"        public SubtractQuantityPlugin(string unsecureConfiguration, string secureConfiguration)",
			"            : base(typeof(SubtractQuantityPlugin))",
			"        {",
			"        }",
			"",
			"        protected override void ExecuteDataversePlugin(ILocalPluginContext localPluginContext)",
			"        {",
			"            if (localPluginContext == null)",
			"            {",
			"                throw new ArgumentNullException(nameof(localPluginContext));",
			"            }",
			"",
			"            var context = localPluginContext.PluginExecutionContext;",
			"            var serviceFactory = localPluginContext.OrgSvcFactory;",
			"            var service = serviceFactory.CreateOrganizationService(context.UserId);",
			"",
			"            if (!(context.InputParameters[\"Target\"] is Entity target) || target.LogicalName != \"tom_warehousetransaction\")",
			"                return;",
			"",
			"            if (!target.Contains(\"tom_quantity\") || !target.Contains(\"tom_itemid\"))",
			"                return;",
			"",
			"            var quantity = ((int)target[\"tom_quantity\"]);",
			"            var itemRef = (EntityReference)target[\"tom_itemid\"];",
			"",
			"            var item = service.Retrieve(\"tom_warehouseitem\", itemRef.Id, new ColumnSet(\"tom_availablequantity\"));",
			"            var available = ((int)item[\"tom_availablequantity\"]);",
			"",
			"            item[\"tom_availablequantity\"] = available - quantity;",
			"            service.Update(item);",
			"        }",
			"    }",
			"}"
		]
	},
	"Build and Register Plugin in PRT": {
		"scope": "powershell",
		"prefix": "CFC05-register-plugin",
		"body": [
			"# ╔════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║                            CFC05: Register Plugin in PRT                           ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# Step 1: Build plugin",
			"   cd src/Plugins.Warehouse",
			"   dotnet build",
			"   cd ../..",
			"#",
			"# Step 2: Open Plugin Registration Tool (from PowerApps Tools)",
			"#",
			"pac tool prt",
			"#",
			"# Step 4: Register Assembly → Select DLL → Storage: Database, Isolation: Sandbox",
			"#",
			"# Step 5: Register two steps:",
			"# ────── ValidateWarehouseTransactionPlugin:",
			"#    - Message: Create",
			"#    - Entity: tom_warehousetransaction",
			"#    - Filtering Attributes: tom_itemid, tom_quantity",
			"#    - Stage: PreValidation",
			"#    - Mode: Synchronous",
			"# ────── SubtractQuantityPlugin:",
			"#    - Message: Create",
			"#    - Entity: tom_warehousetransaction",
			"#    - Filtering Attributes: tom_itemid, tom_quantity",
			"#    - Stage: PostOperation",
			"#    - Mode: Synchronous"
		]
	},
	"Add Plugin Assembly to Solution (maker portal)": {
		"scope": "powershell",
		"prefix": "CFD06-add-plugin-ui",
		"body": [
			"# ╔════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║              CFD06: Add Existing Plugin Assembly to Solution (UI)                 ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# Step 1: Open Maker Portal",
			"    pac tool maker",
			"#",
			"# Step 2: Navigate to Solutions → Open your solution (e.g. Solution.Logic)",
			"#",
			"# Step 3: Click [Add existing] → [More] → [Plugin assembly]",
			"#",
			"# Step 4: Select WarehousePlugin assembly from the list",
			"#",
			"# Step 5: Click [Add] to include the assembly in your solution",
		]
	},
	"Link plugin project to Dataverse solution for live development": {
		"scope": "powershell",
		"prefix": "CFD07-link-plugin-solution",
		"body": [
			"#",
			"# ╔════════════════════════════════════════════════════════════════════════════════════════╗",
			"# ║       CFD07: Link plugin project to Dataverse solution for live plugin development     ║",
			"# ╚════════════════════════════════════════════════════════════════════════════════════════╝",
			"#",
			"# This script links the Plugins.Warehouse plugin project to the Dataverse solution project",
			"# so that any changes made to the plugin code can be included in the solution package.",
			"#",
			"# You can run this anytime you add, remove, or refactor plugin logic. It keeps the",
			"# Dataverse solution (cdsproj) up-to-date with project references.",
			"#",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"#                                        Commands",
			"# ──────────────────────────────────────────────────────────────────────────────────────────",
			"cd src/SolutionsLogic",
			"",
			"# Step 1: Sync the Dataverse solution project to ensure .cdsproj is ready",
			"pac solution sync --solution-folder Declarations",
			"",
			"# Step 2: Add reference to the plugin project",
			"pac solution add-reference --path ../Plugins.Warehouse/Plugins.Warehouse.csproj",
			"",
			"cd ../..",
		]
	}
}
